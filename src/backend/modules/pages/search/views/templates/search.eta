<% it.meta = {
  title: 'Search | Godot Asset Library',
  description: `Find the best ${it?.originalQuery} Assets for Godot Engine on Godot Asset Library`,
  url: `https://godotassetlibrary.com/${it?.params}`,
  moduleName: 'search'
} %>
<% layout('templates/components/layouts/promobar-nav-body-footer.eta') %>
<section class="page-search">
  <section>
    <% for (const [filtersKey, filtersValue] of Object.entries(it.filters)) { %>
    <div class="catalog-filters">
      <div class="filter">
        <h2><%= filtersKey === 'category' ? 'Category Filters' : 'Engine Filters' %></h2>
        <hr>
        <div class="options">
          <ul>
            <% 
              var sharedParams = []
              var categoryOrEngineRegex = /(\/category\/|\/engine\/)/
              var acceptedParams = ['category', 'engine', 'page', 'sort', 'order']
              
              if (categoryOrEngineRegex.test(it?.params)) {
                var name = it?.params.split(categoryOrEngineRegex)[1]
                sharedParams.push({name: name.replace(/\//g, ''), value: it.params.replace(categoryOrEngineRegex, '')})
              }

              for (const [key, value] of Object.entries(filtersValue)) { %>
            <li>
              <label>
                <% 
                    let filterParams = new URLSearchParams(it.params ?? '?q=')
                    let filterAlreadyAdded = false
                    let filterLink = ''
                    
                    if (!Array.from(filterParams.keys())[0].includes('/search/')) {
                      var name = Array.from(filterParams.keys())[0]
                      filterParams.delete(name)
                      filterParams.set('/search/?q', '')
                    } 

                    sharedParams.forEach(param => {
                      filterParams.append(param.name, param.value)
                    })

                    Array.from(filterParams.keys()).forEach(key => {
                      if(!acceptedParams.includes(key)) {
                        filterParams.delete(key)
                      }
                    })

                    let currentParams = filterParams.getAll(filtersKey)
                    
                    filterParams.set('page', 0)

                    if (currentParams.includes(key.toLocaleLowerCase()) || currentParams.includes(key)) {
                      filterAlreadyAdded = true

                      const paramsToArray = decodeURIComponent(filterParams.toString()).split('&')
                      filterLink = paramsToArray.filter((v, i, a) => a.indexOf(v) === i)
                                      .filter(e => e !== `${filtersKey}=${key.toLocaleLowerCase().replace(/\s+/g, '+')}`)
                                      .join(',')
                                      .replace(/,/g, '&')
                    } else {
                      filterParams.append(filtersKey, String(key.toLocaleLowerCase()))
                      filterLink = decodeURIComponent(filterParams.toString())
                    }
                  %>
                <a href="<%= filterLink %>" title="Add to filters">
                  <input type="checkbox" <%= filterAlreadyAdded ? 'checked' : '' %>>
                  <%= `${filtersKey == 'engine' ? 'Godot' : ''}  ${String(key)}` %> (<%= String(value) %>)
                </a>
              </label>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </div>
    <% } %>
  </section>

  <section>
    <%~ includeFile('templates/components/partials/catalog-grid.eta', it) %>
  </section>
</section>
